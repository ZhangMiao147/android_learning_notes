# 3. EasyAR-å½•å±

å®˜ç½‘æ¨èåœ°å€ï¼š[EasyAR4.0ä½¿ç”¨è¯´æ˜ï¼ˆUnity3Dï¼‰ä¹----å±å¹•å½•åƒ - æ¸¸æˆç¼–ç¨‹ ğŸ•¹ï¸](https://www.233tw.com/unity/1683)

å®˜æ–¹æ¨èè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1Kt4y1m7Ch/?spm_id_from=autoNext

å¼•å…¥ EasyAR æ’ä»¶å¯ä»¥æŸ¥çœ‹ç¬¬ 2 ç¯‡ã€‚

## 1. åˆ›å»ºåœºæ™¯

åˆ›å»ºä¸€ä¸ªæ–°çš„åœºæ™¯ï¼Œå°† Main Camera çš„ Tag è®¾ç½®ä¸º â€œMainCameraâ€ï¼ŒClear Flags è®¾ç½®ä¸º "Solid Color"ã€‚

![](img/camera.jpg)

åœ¨ Hierarchy ç‚¹å‡»ï¼Œæ·»åŠ  AR Session(FrameSource Present):Camera Device Only

![](img/session.png)

åˆ›å»ºå¥½ä¹‹åï¼Œåœ¨ AR Sessionï¼ˆEasyARï¼‰ä¸‹çš„ Camera Device ä¸­ Camera å°† Main Camera æ‹–è¿›å»ã€‚

![](img/record_camera.jpg)

åŒæ ·çš„æ–¹å¼ï¼Œå†æ·»åŠ ä¸€ä¸ª Video Recorderã€‚

![](img/recorder.png)

ä¿®æ”¹ Video Recorder çš„å±æ€§ã€‚å°† File Path Type ï¼ˆæ–‡ä»¶åœ°å€ç±»å‹ï¼‰ä¿®æ”¹ä¸ºâ€œPersistent Data Pathâ€ï¼Œå°† FilePath å¡«å†™ä¸€ä¸ªå­˜å‚¨çš„è§†é¢‘åç§°ã€‚

![](img/recorder_file.jpg)

åˆ›å»ºä¸¤ä¸ªç®€å•çš„æŒ‰é’®ä¸æ–‡æœ¬ï¼Œå¦‚ä¸‹å›¾ã€‚

![](img/button.jpg)

## 2. ä»£ç 

åˆ›å»ºä¸€ä¸ª Script æ–‡ä»¶å¤¹ï¼Œåˆ›å»ºä¸€ä¸ª C# Script æ–‡ä»¶ï¼Œå‘½åä¸º CameraRecorderï¼Œä»£ç ï¼ˆå®˜ç½‘ç¤ºä¾‹ä¸­çš„å®ç°ä»£ç ï¼‰å¦‚ä¸‹ï¼š

```
//================================================================================================================================
//
//  Copyright (c) 2015-2021 VisionStar Information Technology (Shanghai) Co., Ltd. All Rights Reserved.
//  EasyAR is the registered trademark or trademark of VisionStar Information Technology (Shanghai) Co., Ltd in China
//  and other countries for the augmented reality technology developed by VisionStar Information Technology (Shanghai) Co., Ltd.
//
//================================================================================================================================

using easyar;
using UnityEngine;

    public class CameraRecorder : MonoBehaviour
    {
        private VideoRecorder videoRecorder;
        private Material externalMaterial;
        private RenderTexture rt;

        public void OnRenderImage(RenderTexture source, RenderTexture destination)
        {
            Graphics.Blit(source, destination);
            if (videoRecorder)
            {
                if (externalMaterial)
                {
                    if (rt && (rt.width != source.width || rt.height != source.height))
                    {
                        Destroy(rt);
                    }
                    if (!rt)
                    {
                        rt = new RenderTexture(source.width, source.height, 0);
                    }
                    Graphics.Blit(source, rt, externalMaterial);
                    videoRecorder.RecordFrame(rt);
                }
                else
                {
                    videoRecorder.RecordFrame(source);
                }
            }
        }

        public void Setup(VideoRecorder recorder, Material material)
        {
            videoRecorder = recorder;
            externalMaterial = material;
        }

        public void Destroy()
        {
            if (rt)
            {
                Destroy(rt);
            }
            Destroy(this);
        }
    }
```

å†åˆ›å»ºä¸€ä¸ª C# Script æ–‡ä»¶ï¼Œå‘½åä¸º RecorderControllerï¼Œä»£ç å¦‚ä¸‹ï¼š

```
using System.Collections;
using System.Collections.Generic;
using easyar;
using UnityEngine;
using UnityEngine.UI;

public class RecorderController : MonoBehaviour
{
    public Text uiText;
    public VideoRecorder videoRecorder;
    private CameraRecorder cameraRecorder;

    void Awake()
    {
        Debug.Log("Awake");
        videoRecorder.StatusUpdate += (status, msg) =>
        {
            if (status == RecordStatus.OnStarted)
            {
                uiText.text = "Recording start";
            }
            if (status == RecordStatus.FailedToStart ||
            status == RecordStatus.FileFailed || status == RecordStatus.LogError)
            {
                uiText.text = "Recording Error:" + status + ",default:" + msg;
            }
            Debug.Log("RecordStatus:" + status + ",details:" + msg);
        };
    }

    public void StartRecorder() {
        uiText.text = "StartRecorder";
        Debug.Log("StartRecorder");
        videoRecorder.StartRecording();
        cameraRecorder = Camera.main.gameObject.AddComponent<CameraRecorder>();
        uiText.text = "StartRecorder cameraRecorder:" + cameraRecorder;
        cameraRecorder.Setup(videoRecorder, null);
    }

    public void StopRecorder() {
        Debug.Log("StopRecorder");
        if (videoRecorder.StopRecording())
        {
            uiText.text = "Recording stop " + videoRecorder.FilePath;
        }
        else {
            uiText.text = "Recording failed";
        }
        if (cameraRecorder) {
            cameraRecorder.Destroy();
        }

    }

    // Start is called before the first frame update
    void Start()
    {

    }

    // Update is called once per frame
    void Update()
    {

    }
}
```

åœ¨åœºæ™¯ä¸­å†åˆ›å»ºä¸€ä¸ªç©ºå®ä½“ï¼Œå°† RecorderController ç»‘å®šåœ¨ä¸Šé¢ï¼Œå°†ä¸Šé¢åˆ›å»ºçš„ Text å’Œ Video Recorder æ‹–åˆ°ç›¸åº”ä½ç½®ã€‚

![](img/empty.jpg)

è®¾ç½®ä¸€ä¸‹ä¸¤ä¸ª Button çš„ç‚¹å‡»äº‹ä»¶

![](img/click.jpg)

## 3.è¿è¡Œ

è¿›å…¥ Build Settingsï¼Œæ·»åŠ ç›®å‰çš„åœºæ™¯ï¼Œåˆ‡æ¢åˆ° Android å¹³å°ï¼Œè¿›å…¥ Player Settingsï¼Œ1.åˆ é™¤ Vulkanï¼Œ2.å–æ¶ˆ Multithreaded Rendering çš„å‹¾é€‰ã€‚

![](img/record-setting.jpg)

ç‚¹å‡» Build And Run å°±å¯ä»¥è¿è¡Œåˆ°è®¾å¤‡ä¸Šã€‚

è§†é¢‘ä¿å­˜ä¼šæ”¾åœ¨ Android/data/<package name>/files æ–‡ä»¶å¤¹é‡Œã€‚

å½•åˆ¶ä¸‹æ¥çš„è§†é¢‘æ•ˆæœï¼š

![](img/recordTest.gif)
